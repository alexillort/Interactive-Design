<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Interacción - Tracking de Dos Manos</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; cursor: pointer; }
        canvas { position: absolute; top: 0; left: 0; transform: scaleX(-1); }
        #background-canvas { filter: grayscale(100%); z-index: 1; }
        #interaction-canvas { z-index: 2; }
        #input_video { display: none; } 
    </style>
</head>
<body>
    <video id="input_video" autoplay playsinline></video>
    <canvas id="background-canvas"></canvas>
    <canvas id="interaction-canvas"></canvas>

    <script type="module">
        import { HandLandmarker, FilesetResolver, DrawingUtils } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14";

        const HAND_CONNECTIONS = [[0, 1], [1, 2], [2, 3], [3, 4], [0, 5], [5, 6], [6, 7], [7, 8], [5, 9], [9, 10], [10, 11], [11, 12], [9, 13], [13, 14], [14, 15], [15, 16], [13, 17], [17, 18], [18, 19], [19, 20], [0, 17]];

        const video = document.getElementById("input_video");
        const bgCanvas = document.getElementById("background-canvas");
        const bgCtx = bgCanvas.getContext("2d");
        const intCanvas = document.getElementById("interaction-canvas");
        const intCtx = intCanvas.getContext("2d");
        const drawingUtils = new DrawingUtils(intCtx);
        
        let handLandmarker;
        let particlesArray = [];
        let handLandmarksPoints = [];
        
        let showTracking = false;

        const INTERACTION_RADIUS = 120;

        function activateTrackingVisibility() {
            showTracking = true;
            window.removeEventListener('click', activateTrackingVisibility);
            window.removeEventListener('touchstart', activateTrackingVisibility);
        }

        window.addEventListener('click', activateTrackingVisibility);
        window.addEventListener('touchstart', activateTrackingVisibility);

        class Particle {
            constructor() {
                this.x = Math.random() * intCanvas.width;
                this.y = Math.random() * intCanvas.height;
                this.size = Math.random() * 5 + 1;
                this.speedX = Math.random() * 2 - 1;
                this.speedY = Math.random() * 2 - 1;
                this.color = `hsl(${Math.random() * 360}, 100%, 75%)`;
            }
            
            update() {
                handLandmarksPoints.forEach(point => {
                    let dx = this.x - point.x;
                    let dy = this.y - point.y;
                    let distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < INTERACTION_RADIUS) {
                        let forceDirectionX = dx / distance;
                        let forceDirectionY = dy / distance;
                        let force = (INTERACTION_RADIUS - distance) / INTERACTION_RADIUS;
                        this.x += forceDirectionX * force * 10;
                        this.y += forceDirectionY * force * 10;
                    }
                });

                this.x += this.speedX;
                this.y += this.speedY;
                if (this.x > intCanvas.width || this.x < 0) this.speedX *= -1;
                if (this.y > intCanvas.height || this.y < 0) this.speedY *= -1;
             }

            draw() {
                intCtx.fillStyle = this.color;
                intCtx.beginPath();
                intCtx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                intCtx.fill();
            }
        }

        function initParticles() { for (let i = 0; i < 2000; i++) { particlesArray.push(new Particle()); } }
        
        async function createHandLandmarker() {
            const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm");
            // --- CAMBIO 1: AUMENTAR EL NÚMERO DE MANOS ---
            // Cambiamos numHands de 1 a 2 para detectar ambas manos.
            handLandmarker = await HandLandmarker.createFromOptions(vision, { 
                baseOptions: { modelAssetPath: `https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task`, delegate: "GPU" }, 
                runningMode: "VIDEO", 
                numHands: 2 
            });
            startCamera();
        }
        createHandLandmarker();

        function startCamera() {
            navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
                video.srcObject = stream;
                video.addEventListener("loadeddata", () => {
                    [bgCanvas, intCanvas].forEach(c => { c.width = video.videoWidth; c.height = video.videoHeight; });
                    const scaleFactor = Math.min(window.innerWidth / video.videoWidth, window.innerHeight / video.videoHeight);
                    const newWidth = video.videoWidth * scaleFactor;
                    const newHeight = video.videoHeight * scaleFactor;
                    const newLeft = (window.innerWidth - newWidth) / 2;
                    const newTop = (window.innerHeight - newHeight) / 2;
                    [bgCanvas, intCanvas].forEach(c => { c.style.width = `${newWidth}px`; c.style.height = `${newHeight}px`; c.style.left = `${newLeft}px`; c.style.top = `${newTop}px`; });
                    initParticles();
                    animate();
                });
            });
        }

        function animate() {
            bgCtx.drawImage(video, 0, 0, bgCanvas.width, bgCanvas.height);
            intCtx.clearRect(0, 0, intCanvas.width, intCanvas.height);
            particlesArray.forEach(p => { p.update(); p.draw(); });

            if (handLandmarker) {
                const results = handLandmarker.detectForVideo(video, performance.now());
                handLandmarksPoints = []; // Limpiamos los puntos en cada frame
                
                // --- CAMBIO 2: PROCESAR TODAS LAS MANOS DETECTADAS ---
                // Usamos un bucle for...of para iterar sobre cada conjunto de landmarks (cada mano)
                if (results.landmarks) {
                    for (const landmarks of results.landmarks) {
                        // Guardamos los puntos de esta mano para la interacción con partículas
                        for (const landmark of landmarks) {
                            handLandmarksPoints.push({
                                x: landmark.x * intCanvas.width,
                                y: landmark.y * intCanvas.height
                            });
                        }
                        
                        // Dibujamos el tracking solo si está activado
                        if (showTracking) {
                            drawingUtils.drawConnectors(landmarks, HAND_CONNECTIONS, { color: '#FFFFFF', lineWidth: 2 });
                            drawingUtils.drawLandmarks(landmarks, { color: '#00FF00', lineWidth: 1, radius: 3 });
                        }
                    }
                }
            }
            requestAnimationFrame(animate);
        }
    </script>
</body>

</html>
